@page "/subscribe"
@using CaloriesCatcher.UI.Model
@using CaloriesCatcher.UI.Service;
@using Microsoft.Extensions.Options
@using System.Security.Claims

<MudCard Elevation="3" Outlined="true" Class="mt-5 mx-auto" Style="max-width: 500px;">
    <MudCardContent>
        <MudSelect T="Subscription" @bind-Value="SelectedSubscription">
            <MudSelectItem Value="@TurtleSubscription">Turtle (Free)</MudSelectItem>
            <MudSelectItem Value="@ElephantSubscription">Elephant ($0.99)</MudSelectItem>
            <MudSelectItem Value="@ParrotSubscription">Parrot ($1.99)</MudSelectItem>
        </MudSelect>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Subscribe" Class="mt-3">Subscribe Now</MudButton>
    </MudCardContent>
</MudCard>

@code {
    [Inject] StripePaymentsService stripeService { get; set; }
    [CascadingParameter] Task<AuthenticationState> authenticationState { get; set; } = default!;
    [Inject] IJSRuntime JSRuntime { get; set; }
    [Inject] ISnackbar snackbar { get; set; }
    [Inject] IOptions<StripeSettings> stripeSettings { get; set; }
    public Subscription TurtleSubscription { get; set; }
    public Subscription ElephantSubscription { get; set; } 
    public Subscription ParrotSubscription { get; set; } 
    public string role { get; set; } = string.Empty;
    Subscription SelectedSubscription;

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationState;
        role = authState.User.FindFirst(ClaimTypes.Role)?.Value;
        if (string.IsNullOrEmpty(role))
        {
            role = "Turtle";
        }
        SelectedSubscription = new Subscription();
        TurtleSubscription = new  Subscription { Name = "Turtle", MonthlyPrice = 0.00M };
        ElephantSubscription = new Subscription { Name = "Elephant", MonthlyPrice = 0.99M, PriceId = "price_1O3kU6CvoZQgmYDTz2m2Q4Sx" };
        ParrotSubscription = new Subscription { Name = "Parrot", MonthlyPrice = 1.99M, PriceId = "price_1O3kVYCvoZQgmYDTLLokRW7M" };
        if (role.ToLower() == TurtleSubscription.Name.ToLower())
        {
            SelectedSubscription = TurtleSubscription;  
        } else if (role.ToLower() == ElephantSubscription.Name.ToLower())
        {
            SelectedSubscription = ElephantSubscription;
        }
        else
        {
            SelectedSubscription = ParrotSubscription;
        }
        
        
    }

    private async Task Subscribe()
    {
        if (SelectedSubscription.Name.ToLower() == role.ToLower())
        {
            snackbar.Add("You already have this subscription");
        }
        else
        {
            var priceId = SelectedSubscription.PriceId;  // Assume you have the price ID from the selected subscription
            var sessionId = await stripeService.CreateCheckoutSessionAsync(priceId);
            await RedirectToCheckout(sessionId.ToString());
        }
    }

    private async Task RedirectToCheckout(string sessionId)
    {
        var redirectToCheckoutJs = @"
        var stripe = Stripe('" + stripeSettings.Value.PublishableKey + @"');
        stripe.redirectToCheckout({ sessionId: '" + sessionId + @"' })
            .then(function (result) {
                if (result.error) {
                    alert(result.error.message);
                }
            });
        ";
        await JSRuntime.InvokeVoidAsync("eval", redirectToCheckoutJs);
    }
}
